// Версия плагина: 0.4 Alpha
// Плагин изменяет порядок отображения кнопок в карточке фильма/сериала.
// Новый порядок:
// 1. Кнопки онлайн-просмотра
// 2. Кнопки торрентов
// 3. Кнопки трейлеров
// 4. Все остальные кнопки
//
// Дополнительно:
// - Заменяет текст основных кнопок («Онлайн», «Торренты», «Трейлер») на цветные SVG-иконки
// - Применяет flex-отображение с отступами (удобно на TV)
// - Очищает пользовательскую настройку приоритета кнопок (full_btn_priority),
//   чтобы не конфликтовала с логикой плагина

Lampa.Platform.tv();

// Очищаем пользовательский приоритет кнопок
Lampa.Storage.set('full_btn_priority', '');

(function () {
    // SVG-иконки для разных типов кнопок (восстановлены из обфусцированного кода)
    const icons = {
        online: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path fill="#00a99d" d="M29.5 16c0 7.18-5.82 13-13 13S3.5 23.18 3.5 16 9.32 3 16.5 3 29.5 8.82 29.5 16zM6.5 16c0 5.523 4.477 10 10 10s10-4.477 10-10-4.477-10-10-10-10 4.477-10 10zm10-6c.276 0 .5.224.5.5v11c0 .276-.224.5-.5.5s-.5-.224-.5-.5v-11c0-.276.224-.5.5-.5zm-4.5 3.5c.276 0 .5.224.5.5v7c0 .276-.224.5-.5.5s-.5-.224-.5-.5v-7c0-.276.224-.5.5-.5zm9 0c.276 0 .5.224.5.5v7c0 .276-.224.5-.5.5s-.5-.224-.5-.5v-7c0-.276.224-.5.5-.5z"/></svg>',

        torrent: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path fill="#f26522" d="M29.5 16c0 7.18-5.82 13-13 13S3.5 23.18 3.5 16 9.32 3 16.5 3 29.5 8.82 29.5 16zM6.5 16c0 5.523 4.477 10 10 10s10-4.477 10-10-4.477-10-10-10-10 4.477-10 10zm5-4.5c.276 0 .5.224.5.5v8c0 .276-.224.5-.5.5s-.5-.224-.5-.5v-8c0-.276.224-.5.5-.5zm4 0c.276 0 .5.224.5.5v8c0 .276-.224.5-.5.5s-.5-.224-.5-.5v-8c0-.276.224-.5.5-.5zm4 0c.276 0 .5.224.5.5v8c0 .276-.224.5-.5.5s-.5-.224-.5-.5v-8c0-.276.224-.5.5-.5zm-8 3c.276 0 .5.224.5.5v2c0 .276-.224.5-.5.5s-.5-.224-.5-.5v-2c0-.276.224-.5.5-.5zm12 0c.276 0 .5.224.5.5v2c0 .276-.224.5-.5.5s-.5-.224-.5-.5v-2c0-.276.224-.5.5-.5z"/></svg>',

        trailer: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path fill="#7556a8" d="M29.5 16c0 7.18-5.82 13-13 13S3.5 23.18 3.5 16 9.32 3 16.5 3 29.5 8.82 29.5 16zM6.5 16c0 5.523 4.477 10 10 10s10-4.477 10-10-4.477-10-10-10-10 4.477-10 10zm2-3.5c.276 0 .5.224.5.5v6c0 .276-.224.5-.5.5s-.5-.224-.5-.5v-6c0-.276.224-.5.5-.5zm4 0c.276 0 .5.224.5.5v6c0 .276-.224.5-.5.5s-.5-.224-.5-.5v-6c0-.276.224-.5.5-.5zm4 0c.276 0 .5.224.5.5v6c0 .276-.224.5-.5.5s-.5-.224-.5-.5v-6c0-.276.224-.5.5-.5zm4 0c.276 0 .5.224.5.5v6c0 .276-.224.5-.5.5s-.5-.224-.5-.5v-6c0-.276.224-.5.5-.5z"/></svg>'
    };

    // Определяем тип кнопки по её тексту
    function getType(button) {
        const text = $(button).text().toLowerCase().trim();

        if (text.includes('онлайн') || text.includes('online')) return 'online';
        if (text.includes('торрент') || text.includes('torrent')) return 'torrent';
        if (text.includes('трейлер') || text.includes('trailer')) return 'trailer';
        return 'other';
    }

    // Приоритет для сортировки (меньше = выше)
    function getPriority(type) {
        return { online: 0, torrent: 1, trailer: 2, other: 3 }[type] || 3;
    }

    // Основная логика — выполняется при открытии полной карточки
    Lampa.Listener.follow('full', function () {
        // Контейнер и кнопки (актуальные селекторы для современных версий Lampa)
        const container = $('.view--card .card__buttons');
        const buttons = container.find('.card__button');

        if (!buttons.length) return;

        // Заменяем текст на иконки для основных типов
        buttons.each(function () {
            const type = getType(this);
            if (icons[type]) {
                // Сохраняем оригинальный текст в title (для доступности и подсказки)
                const originalText = $(this).text().trim();
                $(this).attr('title', originalText);
                $(this).html(icons[type]);
            }
        });

        // Сортируем кнопки
        const sortedButtons = buttons.toArray().sort((a, b) => {
            return getPriority(getType(a)) - getPriority(getType(b));
        });

        // Перестраиваем DOM
        buttons.detach();
        container.append(sortedButtons);

        // Применяем flex-стиль для красивого отображения (особенно на TV)
        container.css({
            'display': 'flex',
            'flex-wrap': 'wrap',
            'gap': '10px',
            'justify-content': 'center'
        });
    });
})();
